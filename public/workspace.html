<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Workspace</title>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
       background: linear-gradient(to right, #6ee7b7, #3b82f6); 
       font-family: Arial, sans-serif; 
      }
    .workspace-container { width: 80%; 
      margin: 20px auto; 
      background: #fff; 
      border-radius: 10px;
       box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        overflow: hidden; 
      }
    .workspace-header { 
      background: #3b82f6; 
      color: #fff; 
      padding: 12px;
      font-weight: bold; 
      text-align: center; 
      font-size: 20px;
     }
    .workspace-body {
       display: flex; 
       height: 420px;
     }
    .main-panel { 
      flex: 3; 
      background: #f9fafb;
      padding: 12px; 
      overflow-y: auto; 
      border-right: 1px solid #ddd; 
    }
    .side-panel { 
      flex: 1; 
      padding: 12px;
      background: #f3f4f6; 
    }
    .incoming-item { 
      background: #f1f5f9;
      padding: 10px; 
      margin-bottom: 10px; 
      border-radius: 6px; 
      border: 1px solid #ddd;
     }
    .incoming-item b {
       color: #1e3a8a; 
      }
    .btn {
       padding: 6px 12px; 
       border: none;
       border-radius: 4px; 
       cursor: pointer; 
       font-size: 13px;
        margin: 4px; 
      }
    .btn-view { 
      background: #3b82f6;
       color: #fff; }
    .btn-verify {
       background: #10b981; 
       color: #fff; 
      }
    .btn-danger { 
      background: #ef4444;
      color: #fff; 
     }
    .btn-send { 
      background: #2563eb;
      color: #fff; 
    }
    .file-input { 
      padding: 15px; 
      background: #f1f5f9;
      border-top: 1px solid #ddd;
      display: flex; gap: 8px; 
      align-items: center; 
      justify-content: space-between;
     }
    .file-input input, .file-input select { 
      padding: 6px; 
      font-size: 14px;
     }
    #acknowledge { 
      font-size: 14px; 
      margin-top: 6px; color: green; 
      font-weight: bold; 
    }
    #acknowledge.error { 
      color: red; 
    }
    #pending { 
      font-size: 13px; 
      color: #555; 
    }
  </style>
</head>
<body>
  <div class="workspace-container">
    <div class="workspace-header" id="workspaceTitle">Workspace</div>

    <div class="workspace-body">
      <div class="main-panel" id="incoming-list"></div>
      <div class="side-panel">
        <p><b>Workspace Info</b></p>
        <div id="userinfo"></div>
        <button id="endBtn" class="btn btn-danger">End Workspace</button>
        <hr>
        <p><b>Pending / Incoming</b></p>
        <div id="pending">No incoming files yet.</div>
        <hr>
        <p><b>Status</b></p>
        <div id="acknowledge"></div>
      </div>
    </div>

    <div class="file-input">
      <input type="text" id="recipient" placeholder="Recipient username (or 'all')" />
      <input type="text" id="fname" placeholder="File name (optional)" />
      <select id="ftype">
        <option value="pdf">PDF</option>
        <option value="image">Image</option>
        <option value="video">Video</option>
      </select>
      <input type="file" id="file" />
      <button id="sendBtn" class="btn btn-send">Send</button>
    </div>
  </div>

  <script>
  (async function() {
    const socket = io();

    // Resolve room and username from sessionStorage first
    const urlParams = new URLSearchParams(window.location.search);
    let room = sessionStorage.getItem('room') || urlParams.get('room');
    let username = sessionStorage.getItem('user');

    // If URL param had room, persist into sessionStorage
    if (urlParams.get('room')) {
      sessionStorage.setItem('room', urlParams.get('room'));
      room = urlParams.get('room');
    }

    if (!username || !room) {
      alert('Missing user or workspace. Please login/create workspace first.');
      window.location.href = '/index.html';
      return;
    }

    // Update UI
    document.getElementById("workspaceTitle").innerText = "Workspace: " + room;
    document.getElementById("userinfo").innerText = "You: " + username + " · Room: " + room;

    // Register with socket
    socket.emit("register", username);
    socket.emit("join_room", { room, username });

    socket.on('join_failed', (d) => {
      alert('Failed to join workspace: ' + (d.reason || 'no_room'));
      window.location.href = '/index.html';
    });

    // SEND button
    document.getElementById("sendBtn").onclick = async () => {
      const file = document.getElementById("file").files[0];
      const recipient = document.getElementById("recipient").value || "all";
      if (!file) { alert("Please select a file!"); return; }

      const form = new FormData();
      form.append("file", file);
      form.append("recipient", recipient);
      form.append("room", room);
      form.append("ftype", document.getElementById("ftype").value);
      form.append("fname", document.getElementById("fname").value);

      const resp = await fetch("/api/upload", { method: "POST", body: form });
      const data = await resp.json();

      if (!data.ok) {
        document.getElementById("acknowledge").classList.add("error");
        document.getElementById("acknowledge").innerText = "Upload failed: " + (data.error || "Unknown error");
      } else {
        document.getElementById("acknowledge").classList.remove("error");
        document.getElementById("acknowledge").innerText = "Upload accepted: " + (data.meta?.originalName || data.transferId);
      }
    };

    // Incoming file
    // Universal incoming file display for both sender and receiver
function addFileItem(d, isSender) {
  // Show sender as "You" for current user
  const label = isSender ? "You" : d.sender;
  const role = isSender ? "sent" : "received";
  const div = document.createElement("div");
  div.className = "incoming-item";
  div.innerHTML = `<b>${label}</b> ${role} <i>${d.filename || 'Unnamed'}</i> [${d.ftype || 'file'}]<br>
    <button class="btn btn-view">View</button>
    <button class="btn btn-verify">Verify</button>`;

  div.querySelector(".btn-view").onclick = async () => {
    const resp = await fetch(`/api/fetch/${d.transferId}`, { credentials: 'include' });
    if (!resp.ok) { alert('Failed to load file'); return; }
    const blob = await resp.blob();
    const contentType = resp.headers.get('Content-Type') || '';
    const url = URL.createObjectURL(blob);
    // Inline PDF preview
    if (contentType.includes('pdf')) {
      const existingEmbed = div.querySelector('embed');
      if (existingEmbed) existingEmbed.remove();
      const embed = document.createElement('embed');
      embed.src = url;
      embed.type = 'application/pdf';
      embed.width = '100%';
      embed.height = '400px';
      embed.style.marginTop = '10px';
      div.appendChild(embed);
    } else {
      window.open(url, "_blank");
    }
  };

  div.querySelector(".btn-verify").onclick = async () => {
    const resp = await fetch(`/api/verify/${d.transferId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ valid: true })
    });
    div.innerHTML += resp.ok
      ? "<br><span style='color:green'>Verified ✓</span>"
      : "<br><span style='color:red'>Verify failed</span>";
  };

  document.getElementById("incoming-list").appendChild(div);
}


// Display incoming or sent files to EVERYONE (sender or recipient)
socket.on("fileIncoming", (d) => {
  // Accept and show if this user is sender or recipient
  if (
    (d.recipient === 'all') ||
    (d.recipient === username) ||
    (d.sender === username)
  ) {
    const isSender = (d.sender === username);
    addFileItem(d, isSender);
    document.getElementById("pending").innerText = "New file received!";
  }
});

// You don't need a separate uploadSuccess handler for file views, as all files are now shown by fileIncoming
// But still show the status for send
socket.on("uploadSuccess", (d) => {
  if (d?.filename) {
    document.getElementById("acknowledge").classList.remove("error");
    document.getElementById("acknowledge").innerText = "File sent successfully: " + d.filename;
  }
});

  })();
  </script>
</body>
</html>
